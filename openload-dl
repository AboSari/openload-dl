#!/usr/bin/python3

#Openload Downloader 


import os
import sys
import requests
import time
from selenium import webdriver
from pyvirtualdisplay import Display

#Questi ci servono per evitare il blocco dei bot da parte di openload
mozilla_header={'User-Agent':'Mozilla/5.0 (X11; Fedora; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0'}


if sys.argv[1].split('.')[-1]=='txt':
    with open(sys.argv[1],'r') as urlfile:
        linklist = urlfile.read().splitlines() 
        print('Download in sequenza di '+str(len(linklist))+' file contenuti nella lista '+sys.argv[1])
else:
    linklist=[sys.argv[1]]



#Creo un display virtuale per il browser
display = Display(visible=0, size=(800, 600))
display.start()
browser=webdriver.Firefox()

for url in linklist:
    browser.get(url)

    #Estraggo il nome del media
    button=browser.find_element_by_css_selector('.other-title-bold')
    filename=button.text
    print("Estrazione link di download per "+filename)
    
    #Cerco il bottone che devo cliccare per il download
    button=browser.find_element_by_css_selector('#btnDl')
    
    #Clicco e chiudo le finestre popup che si aprono
    button.click()
    while(len(browser.window_handles)>1):
        browser.switch_to.window(browser.window_handles[-1])
        browser.close()
    browser.switch_to.window(browser.window_handles[0])

    #Aspetto i 5 secondi
    time.sleep(6)
    
    #Cerco il prossimo bottone
    button=browser.find_element_by_css_selector('span#secondsleftouter')
    
    #Clicco e chiudo le finestre popup che si aprono
    button.click()
    while(len(browser.window_handles)>1):
        browser.switch_to.window(browser.window_handles[-1])
        browser.close()
    browser.switch_to.window(browser.window_handles[0])
    

    #Prendo l'url per il download
    button=browser.find_element_by_css_selector('a.main-button:nth-child(1)')
    downloadurl=button.get_attribute('href')


    #E adesso scarico il file
    print('Download di '+filename+' in corso...')
    with open(filename,'wb') as fp:
        fp.write(requests.get(downloadurl,headers=mozilla_header).content)
    print('Download di '+filename+' completato!')
    

#Chiudo tutto
browser.quit()
display.stop()
os.remove('geckodriver.log')

